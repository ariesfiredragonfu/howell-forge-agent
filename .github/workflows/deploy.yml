# ══════════════════════════════════════════════════════════════════════════════
# Howell Forge — Auto-Deploy to GitHub Packages
#
# Trigger: push to main branch
# Action : build Docker image → push to ghcr.io
#
# The image is then pulled on your server with:
#   docker pull ghcr.io/ariesfiredragonfu/howell-forge-agent:latest
#   docker run --env-file aria.env -p 8765:8765 \
#     ghcr.io/ariesfiredragonfu/howell-forge-agent:latest
# ══════════════════════════════════════════════════════════════════════════════

name: Build & Push ARIA Agent

on:
  push:
    branches: [main]
  # Allow manual trigger from the Actions tab
  workflow_dispatch:

env:
  REGISTRY:   ghcr.io
  IMAGE_NAME: ariesfiredragonfu/howell-forge-agent

jobs:
  build-and-push:
    name: Build Docker image → GitHub Packages
    runs-on: ubuntu-latest

    permissions:
      contents: read     # to check out the repo
      packages: write    # to push to ghcr.io

    steps:
      # ── 1. Source ────────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Docker Buildx (multi-platform + layer cache support) ──────────────
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ── 3. Authenticate to GitHub Packages ───────────────────────────────────
      - name: Log in to GitHub Packages (ghcr.io)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}   # auto-provided, no setup needed

      # ── 4. Compute image tags + OCI labels ────────────────────────────────────
      - name: Extract image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # latest on every main push
            type=raw,value=latest,enable={{is_default_branch}}
            # short commit SHA  e.g.  sha-a1b2c3d
            type=sha,prefix=sha-
            # branch name       e.g.  main
            type=ref,event=branch

      # ── 5. Build and push ─────────────────────────────────────────────────────
      # FreeCAD installation makes this a large build (~3-4 GB image).
      # GitHub Actions cache (type=gha) means subsequent pushes only rebuild
      # changed layers — typically the Python source layer (~seconds).
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context:      .
          push:         true
          tags:         ${{ steps.meta.outputs.tags }}
          labels:       ${{ steps.meta.outputs.labels }}
          # Layer caching — massive speedup after the first full build
          cache-from:   type=gha
          cache-to:     type=gha,mode=max
          # Build args exposed to Dockerfile (add more as needed)
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_SHA=${{ github.sha }}

      # ── 6. Summary ───────────────────────────────────────────────────────────
      - name: Print image digest
        run: |
          echo "## ARIA Agent Image" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Registry | \`ghcr.io/${{ env.IMAGE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tags | \`${{ steps.meta.outputs.tags }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull on your server:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "docker run --env-file aria.env -p 8765:8765 ghcr.io/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
